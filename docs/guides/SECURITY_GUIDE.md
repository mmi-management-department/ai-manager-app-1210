# セキュリティガイド

株式会社エムエムインターナショナル 社内情報検索AIアプリのセキュリティ機能と設定方法をまとめています。

---

## 🛡️ 実装されているセキュリティ機能

### 1. 認証・アクセス制御
- **パスワード認証**
  - 環境変数または Streamlit Secrets で設定
  - SHA-256ハッシュ化（将来的にはより強固なアルゴリズムへの移行を推奨）

### 2. ログイン試行回数制限
- **10分間に5回まで**（デフォルト設定）
- 上限に達すると10分間ロックアウト
- 設定変更可能

### 3. セッション管理
- **セッションタイムアウト：60分**（デフォルト設定）
- タイムアウト後は自動的に再ログイン要求
- ログイン時刻とセッション残り時間の表示

### 4. アクセスログ
- **すべてのログイン試行を記録**
  - タイムスタンプ
  - 成功/失敗
  - ユーザー名
  - IPアドレス（取得可能な場合）
- 最新100件を保持

### 5. IPアドレス制限（オプション）
- ホワイトリスト方式
- 環境変数で設定可能

### 6. 入力のサニタイゼーション
- HTMLエスケープ
- 制御文字の除去
- SQLインジェクション・XSSパターンの検出
- 入力長の制限（デフォルト：10,000文字）

### 7. XSRF保護
- Streamlit標準機能で有効化
- `.streamlit/config.toml` で設定

### 8. センシティブデータの保護
- `.gitignore` で機密ファイルを除外
  - `.env`
  - `.streamlit/secrets.toml`
  - `logs/`
  - `data/`
  - `feedback/`

---

## ⚙️ セキュリティ設定

### 基本設定（環境変数）

```.env
# 必須：アクセスパスワード
ACCESS_PASSWORD=your_secure_password_here

# オプション：認証を無効化（開発環境用）
# DISABLE_AUTH=true

# オプション：セッションタイムアウト（分）
SESSION_TIMEOUT_MINUTES=60

# オプション：最大ログイン試行回数（10分間）
MAX_LOGIN_ATTEMPTS=5

# オプション：IPアドレスホワイトリスト（カンマ区切り）
# IP_WHITELIST=192.168.1.1,192.168.1.2

# 必須：Google API キー
GOOGLE_API_KEY=your_api_key_here
```

### Streamlit Cloud設定

`.streamlit/secrets.toml` に以下を設定：

```toml
# 認証設定
[auth]
password = "your_secure_password_here"
session_timeout_minutes = 60
max_login_attempts = 5
# ip_whitelist = "192.168.1.1,192.168.1.2"

# API キー
GOOGLE_API_KEY = "your_api_key_here"
```

---

## 📋 セキュリティチェックリスト

### デプロイ前の確認事項

#### ✅ 必須項目
- [ ] `ACCESS_PASSWORD` が強固なパスワードに設定されている
- [ ] `GOOGLE_API_KEY` が正しく設定されている
- [ ] `.gitignore` に機密ファイルが含まれている
- [ ] `.streamlit/secrets.toml` がGit管理外になっている
- [ ] `logs/` フォルダが `.gitignore` に含まれている
- [ ] `data/` フォルダが `.gitignore` に含まれている

#### ✅ 推奨項目
- [ ] セッションタイムアウトが適切に設定されている（推奨：30〜120分）
- [ ] ログイン試行回数制限が有効になっている
- [ ] アクセスログが記録されている
- [ ] XSRF保護が有効になっている（`.streamlit/config.toml`）

#### ✅ オプション項目
- [ ] IPアドレス制限が必要な場合は設定されている
- [ ] フィードバック機能が適切に保護されている

---

## 🔐 パスワード管理のベストプラクティス

### 強固なパスワードの条件
1. **最低12文字以上**
2. **大文字・小文字・数字・記号を組み合わせる**
3. **辞書に載っている単語を避ける**
4. **個人情報（誕生日、名前など）を含めない**

### パスワード例（生成方法）
```bash
# Linuxの場合
openssl rand -base64 24

# Pythonの場合
python -c "import secrets; print(secrets.token_urlsafe(24))"
```

### パスワードの定期変更
- **3〜6ヶ月ごとに変更することを推奨**
- 変更時は全社員に通知

---

## 📊 アクセスログの確認

### ログファイルの場所
```
logs/access_log.json
```

### ログの内容
```json
[
  {
    "timestamp": "2025-12-12T10:30:00",
    "success": true,
    "username": "user",
    "ip_address": "192.168.1.100"
  },
  {
    "timestamp": "2025-12-12T10:35:00",
    "success": false,
    "username": "user",
    "ip_address": "192.168.1.101"
  }
]
```

### ログの確認方法
```python
# Python でログを確認
import json

with open('logs/access_log.json', 'r', encoding='utf-8') as f:
    logs = json.load(f)

# 失敗したログイン試行のみ抽出
failed_logins = [log for log in logs if not log['success']]
print(f"失敗したログイン試行: {len(failed_logins)}件")
```

---

## 🚨 セキュリティインシデント対応

### 不正アクセスの疑いがある場合

#### 1. 即座に実施すること
- [ ] パスワードを変更する
- [ ] アクセスログを確認する
- [ ] 不審なIPアドレスを特定する
- [ ] 必要に応じてIPホワイトリストを設定する

#### 2. 調査すること
- [ ] どの時間帯にアクセスがあったか
- [ ] どのIPアドレスからのアクセスか
- [ ] 何回ログイン試行があったか
- [ ] 成功したログインがあるか

#### 3. 報告すること
- 管理者（ai-support@mm-international.co.jp）に報告
- 状況の詳細をまとめる
- ログファイルを保存する

---

## 🔧 トラブルシューティング

### パスワードを忘れた場合
1. 管理者に連絡（ai-support@mm-international.co.jp）
2. 管理者が環境変数またはSecretsのパスワードを確認・リセット

### ログイン試行回数の上限に達した場合
- **10分間待つ**
- 10分後に自動的にリセットされる
- 緊急の場合は管理者に連絡

### セッションがタイムアウトした場合
- 再度ログインする
- 長時間使用する場合は、定期的に操作を行う

---

## 📝 今後のセキュリティ強化案

### 短期的な改善（推奨）
1. **パスワードハッシュのアルゴリズム強化**
   - SHA-256 → bcrypt または Argon2

2. **多要素認証（MFA）の導入**
   - Google Authenticator などのTOTP
   - メールまたはSMSでの認証コード

3. **より詳細なアクセスログ**
   - ユーザーの操作履歴
   - 検索クエリのログ
   - エラーログ

### 中長期的な改善（検討）
1. **ユーザー管理機能**
   - 複数ユーザーの個別アカウント
   - ロールベースのアクセス制御（RBAC）
   - ユーザーごとの権限設定

2. **監査ログ**
   - すべての操作を記録
   - 改ざん防止機能
   - 定期的なレビュー

3. **侵入検知**
   - 異常なアクセスパターンの検出
   - 自動アラート
   - 自動ブロック機能

---

## 📞 お問い合わせ

### セキュリティに関するご質問・報告
- **メール：** ai-support@mm-international.co.jp
- **緊急時：** 上記メールに「【緊急】」を件名に付けて連絡

---

## ✅ セキュリティ確認項目（管理者用）

### 日次
- [ ] アクセスログの確認
- [ ] 異常なログイン試行の有無

### 週次
- [ ] ログファイルのバックアップ
- [ ] セキュリティ設定の確認

### 月次
- [ ] パスワードの変更検討
- [ ] アクセス権限の見直し
- [ ] セキュリティアップデートの確認

### 四半期
- [ ] 全体的なセキュリティレビュー
- [ ] セキュリティポリシーの見直し
- [ ] 社員への周知・教育

---

*最終更新：2025年12月*  
*作成者：株式会社エムエムインターナショナル IT部門*

