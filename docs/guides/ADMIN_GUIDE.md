# 🛠️ 管理者向け運用マニュアル

## 📖 このマニュアルについて

社内AI検索アプリの運用・保守を担当する管理者向けのガイドです。

**対象読者**: 株式会社エムエムインターナショナル 情報システム部、アプリ管理者

---

## 📋 目次

1. [管理者の役割](#管理者の役割)
2. [日常運用](#日常運用)
3. [データ管理](#データ管理)
4. [ユーザーサポート](#ユーザーサポート)
5. [セキュリティ管理](#セキュリティ管理)
6. [トラブル対応](#トラブル対応)
7. [アップデート・メンテナンス](#アップデートメンテナンス)

---

## 管理者の役割

### 主な責任

| 業務 | 頻度 | 所要時間 |
|------|------|---------|
| 稼働状況の確認 | 毎日 | 5分 |
| API使用量の確認 | 毎日 | 3分 |
| ユーザーサポート | 随時 | - |
| データ更新 | 週1回 | 30分 |
| パスワード変更 | 月1回 | 10分 |
| セキュリティ監査 | 月1回 | 60分 |
| バックアップ | 週1回 | 15分 |

### 必要なアクセス権限

- ✅ GitHubリポジトリへの管理者権限
- ✅ Streamlit Cloudの管理者権限
- ✅ Google AI Studioへのアクセス
- ✅ 社内チャット #ai-search-support の管理

---

## 日常運用

### 毎日の確認事項

#### 1. アプリの稼働確認

```bash
# ブラウザでアクセス
https://internal-ai-search-app.streamlit.app

# 確認項目
- [ ] ログイン画面が表示される
- [ ] ログイン後、メイン画面が表示される
- [ ] 質問に対して回答が返される
- [ ] エラーが表示されていない
```

#### 2. Streamlit Cloudステータス確認

```
1. https://share.streamlit.io/ にアクセス
2. ダッシュボードで以下を確認:
   - [ ] アプリのステータスが "Running"
   - [ ] エラーログがないか
   - [ ] メモリ使用量が正常範囲内（< 1GB）
```

#### 3. API使用量の確認

```
1. Google AI Studio にアクセス
   https://aistudio.google.com/app/apikey

2. 使用量を確認:
   - [ ] 1日の制限（1500リクエスト）に近づいていないか
   - [ ] 異常なアクセスパターンがないか
   
3. 警告レベル:
   - 🟢 0-70%: 正常
   - 🟡 70-90%: 注意（使用量が多い）
   - 🔴 90-100%: 警告（制限到達の可能性）
```

#### 4. ログの確認

```
Streamlit Cloud → Settings → Logs

確認項目:
- [ ] エラーログがないか
- [ ] 異常なアクセスパターンがないか
- [ ] 処理時間が長すぎる質問がないか
```

---

## データ管理

### データ更新の手順

#### 毎週の定期更新

```bash
# 1. ローカルでデータを準備
cd "C:\path\to\project"

# 2. 新しいファイルをdataフォルダに配置
# （社内文書を追加・更新）

# 3. 古いデータの確認
# 2年以上前の議事録など、不要なファイルを削除

# 4. ローカルで動作確認
streamlit run main.py
# 新しいデータが検索できるか確認

# 5. GitHubにプッシュ（データはプッシュしない！）
git add .
git commit -m "Update: データ更新処理"
git push

# 6. Streamlit Cloudで手動再起動
# Settings → Reboot app
```

#### データ配置の注意事項

⚠️ **重要**: `data/` フォルダはGitにプッシュしない！

**推奨方法**:
1. サンプルデータのみGitで管理
2. 本番データは Streamlit Cloud に直接配置
3. または外部ストレージ（Google Drive等）から取得

---

### データ最適化

#### ファイル数の管理

```bash
# 現在のファイル数を確認
# Windows
dir /s /b data | find /c /v ""

# ファイル数の目安
- 推奨: 25ファイル以下
- 許容: 50ファイル以下
- 制限: 100ファイル以上は初期化エラーの可能性
```

#### 大量データの対処

```python
# move_large_folders.py を使用
python move_large_folders.py

# 大きなフォルダをバックアップに移動
# - 規則規程について
# - 既読規程以外の社内ルールについて
# など
```

---

## ユーザーサポート

### サポート窓口の運営

#### 社内チャット #ai-search-support

**担当者の役割**:
- ✅ ユーザーからの質問に回答
- ✅ バグ報告の受付と対応
- ✅ 機能改善提案の収集

**よくある質問への回答例**:

```
Q: パスワードがわかりません
A: 現在のパスワードは「[ここにパスワード]」です。
   ピン留めされた投稿も確認してください。

Q: 制限に達しました
A: 全社員で1日750回の制限を共有しています。
   翌朝9時にリセットされますので、しばらくお待ちください。

Q: 情報が見つかりません
A: より具体的なキーワードで検索してみてください。
   または「社内文書検索」と「社内問い合わせ」を切り替えてみてください。
```

---

### フィードバック管理

#### フィードバックの確認

```bash
# フィードバックファイルの場所
feedback/

# 構成
feedback/
├── feedback_20241212_093000.json  # 個別フィードバック
├── feedback_20241212_140500.json
└── quick_feedback_stats.json       # 統計情報
```

#### フィードバックの分析

```python
# 統計の確認
import json

with open("feedback/quick_feedback_stats.json", "r") as f:
    stats = json.load(f)

print(f"役に立った: {stats['helpful']}件")
print(f"改善が必要: {stats['not_helpful']}件")

# 満足度の計算
total = stats['helpful'] + stats['not_helpful']
if total > 0:
    rate = (stats['helpful'] / total) * 100
    print(f"満足度: {rate:.1f}%")
```

#### 改善アクションの決定

```
満足度が80%以下の場合:
1. 個別フィードバックを詳細に分析
2. 共通する問題点を特定
3. 改善計画を立てる
4. ユーザーにフィードバック
```

---

## セキュリティ管理

### パスワード管理

#### 定期変更（月1回）

```bash
# 1. 新しいパスワードを生成
# 推奨: 12文字以上、英数字記号混在
例: InternalAI@2024Dec

# 2. Streamlit Cloud の Secrets を更新
Settings → Secrets

[auth]
password = "新しいパスワード"

Save をクリック

# 3. アプリが自動的に再起動される

# 4. 社内に通知
社内チャット #ai-search-support
メール
社内ポータル
```

#### パスワード変更の通知テンプレート

```
件名: 【重要】社内AI検索アプリのパスワード変更

皆様

セキュリティ強化のため、社内AI検索アプリの
パスワードを変更しました。

■ 新しいパスワード
[ここに新しいパスワード]

■ 有効期限
次回変更予定: 2024年1月1日

このメールは保存せず、削除してください。
パスワードは社内チャット #ai-search-support 
のピン留め投稿でも確認できます。

情報システム部
```

---

### APIキー管理

#### 定期確認

```bash
# 毎月1回: APIキーの使用状況確認

1. Google AI Studio にアクセス
2. APIキーの使用履歴を確認
3. 異常なアクセスがないか確認
```

#### APIキー漏洩時の対応

```bash
# 緊急対応手順

【ステップ1】即座に無効化
1. Google AI Studio にアクセス
2. 該当のAPIキーを削除

【ステップ2】新しいAPIキーを生成
1. 新しいAPIキーを作成
2. キーをコピー

【ステップ3】アプリを更新
1. Streamlit Cloud → Settings → Secrets
2. GOOGLE_API_KEY を新しいキーに更新
3. Save

【ステップ4】影響範囲の調査
1. アクセスログを確認
2. 不正利用の有無を確認
3. 必要に応じて関係者に報告

【ステップ5】再発防止
1. 漏洩経路を特定
2. 対策を実施
3. セキュリティチェックリストを見直し
```

---

### アクセス制御

#### ドメイン制限の設定

```
Streamlit Cloud → Settings → Sharing

【推奨設定】
☑ Restrict to specific email domains
  → @mm-international.co.jp

これにより、社内メールアドレスでのみアクセス可能
```

#### 招待ユーザーの管理

```
Settings → Sharing → Invite viewers

【定期確認（四半期ごと）】
- 退職者のアクセスを削除
- 新入社員を追加
- 部署異動に対応
```

---

## トラブル対応

### トラブル対応フロー

```
【レベル1】個別ユーザーの問題
→ ユーザーサポートで対応

【レベル2】一部機能の問題
→ ログ確認、部分的な修正

【レベル3】全社員に影響
→ 緊急対応、システム停止も検討
```

---

### よくあるトラブルと対処法

#### トラブル1: アプリが起動しない

```
【症状】
- 「Application error」が表示される
- ログインページすら表示されない

【原因と対処】
原因1: APIキーの設定ミス
→ Secrets で GOOGLE_API_KEY を確認

原因2: Streamlit Cloudのメンテナンス
→ https://status.streamlit.io/ で確認

原因3: コードのエラー
→ ログを確認、最新のコミットをロールバック
```

#### トラブル2: 初期化エラーが頻発

```
【症状】
複数のユーザーが「初期化処理に失敗しました」と報告

【原因と対処】
原因1: API制限に達した
→ Google AI Studio で使用量を確認
→ 翌朝まで待つ、または一時的にデータを削減

原因2: データファイルが多すぎる
→ ファイル数を25以下に削減
→ move_large_folders.py を実行

原因3: ChromaDBの問題
→ .chroma フォルダを削除（GitHubで管理してない場合）
→ アプリを再起動して再構築
```

#### トラブル3: 回答が遅い/タイムアウト

```
【症状】
質問してから2分以上かかる、またはタイムアウト

【原因と対処】
原因1: データ量が多い
→ 検索対象のデータを最適化

原因2: 複雑な質問
→ ユーザーに質問を簡潔にしてもらうよう案内

原因3: Google Gemini APIの遅延
→ 一時的な問題の可能性、時間を置いて再試行
```

---

### 緊急時の連絡体制

```
【レベル1】個別の問題
→ 管理者が個別対応

【レベル2】部分的な障害
→ #ai-search-support でアナウンス
→ 管理者が対応

【レベル3】全社的な障害
→ 全社メールでアナウンス
→ 情報システム部長に報告
→ 復旧作業
```

#### 障害通知のテンプレート

```
件名: 【障害情報】社内AI検索アプリ一時停止

皆様

現在、社内AI検索アプリに障害が発生しており、
サービスを一時停止しております。

■ 発生時刻: 2024年12月12日 14:30
■ 影響範囲: 全ユーザー
■ 原因: 調査中
■ 復旧見込: 16:00（予定）

復旧次第、改めてお知らせいたします。
ご不便をおかけし申し訳ございません。

情報システム部
```

---

## アップデート・メンテナンス

### 定期メンテナンス

#### 月次メンテナンス（第1日曜日）

```bash
# 1. 事前告知（1週間前）
社内チャット、メールで通知

# 2. メンテナンス実施
- パスワード変更
- データ更新
- ログのクリーンアップ
- 不要ファイルの削除

# 3. 動作確認
- ログイン確認
- 検索機能確認
- 質問応答確認

# 4. 完了通知
社内に通知
```

#### メンテナンス通知のテンプレート

```
件名: 【メンテナンス予告】社内AI検索アプリ

皆様

下記の日時にて、定期メンテナンスを実施いたします。

■ 日時: 2024年12月1日（日）02:00〜03:00
■ 作業内容:
  - システムアップデート
  - データ更新
  - セキュリティ強化
  
■ 影響: メンテナンス中はアクセスできません

ご理解とご協力をお願いいたします。

情報システム部
```

---

### ソフトウェアアップデート

#### 依存パッケージの更新

```bash
# 1. ローカルで更新を確認
pip list --outdated

# 2. 重要なパッケージをアップデート
pip install --upgrade streamlit
pip install --upgrade langchain
pip install --upgrade langchain-google-genai

# 3. requirements.txt を更新
pip freeze > requirements.txt

# 4. ローカルで動作確認
streamlit run main.py

# 5. GitHubにプッシュ
git add requirements.txt
git commit -m "Update: 依存パッケージのアップデート"
git push

# 6. Streamlit Cloudで自動デプロイ
# 動作確認
```

#### 機能追加の手順

```bash
# 1. ローカルで開発
# 新機能を実装

# 2. テスト
# ローカルで十分にテスト

# 3. ステージング環境で確認
# 可能であれば別のStreamlitアプリで先にテスト

# 4. 本番デプロイ
git add .
git commit -m "Feature: 〇〇機能を追加"
git push

# 5. ユーザーに周知
# 新機能の使い方を案内
```

---

## バックアップ・リカバリ

### バックアップ計画

#### 週次バックアップ

```bash
# 1. GitHubリポジトリ
# 自動でバックアップされている

# 2. Streamlit Cloud の Secrets
# 手動でコピーして安全な場所に保存

# 3. フィードバックデータ
cd feedback/
# ダウンロードして保存

# 4. データファイル
cd data/
# 社内ストレージにバックアップ
```

#### リカバリ手順

```bash
# 最悪の場合: アプリが完全に壊れた

【ステップ1】GitHub からリストア
git clone https://github.com/username/internal-ai-search-app.git
cd internal-ai-search-app

【ステップ2】Streamlit Cloud で再デプロイ
New app → リポジトリを選択

【ステップ3】Secrets を設定
Settings → Secrets → バックアップから復元

【ステップ4】データを配置
dataフォルダにバックアップから復元

【ステップ5】動作確認
```

---

## 監視・モニタリング

### 監視項目

| 項目 | 正常範囲 | 警告レベル | 確認頻度 |
|------|---------|----------|---------|
| 稼働率 | 99%以上 | 95%以下 | 毎日 |
| API使用率 | 70%以下 | 90%以上 | 毎日 |
| 平均応答時間 | 10秒以下 | 30秒以上 | 週1回 |
| エラー率 | 1%以下 | 5%以上 | 週1回 |
| 満足度 | 80%以上 | 70%以下 | 月1回 |

---

## 📊 レポート作成

### 月次レポートのテンプレート

```markdown
# 社内AI検索アプリ 月次レポート
**対象月**: 2024年12月

## 1. 稼働状況
- 稼働率: 99.5%
- 平均応答時間: 8.2秒
- エラー発生回数: 3件

## 2. 利用状況
- 推定質問回数: 約450回/日
- API使用率: 平均60%
- ピーク時間帯: 10:00-11:00, 14:00-15:00

## 3. ユーザーフィードバック
- 役に立った: 135件
- 改善が必要: 20件
- 満足度: 87.1%

## 4. 主なトラブル
- 12/5: API制限到達（対応: データ削減）
- 12/18: 初期化エラー（対応: 再起動）

## 5. 改善実施事項
- ヘルプ機能の追加
- フィードバックフォームの実装

## 6. 来月の予定
- データの定期更新（毎週月曜）
- パスワード変更（1/1）
- ユーザーアンケート実施
```

---

## 📞 サポート・問い合わせ

### 管理者向けサポート

- **Streamlit Community**: https://discuss.streamlit.io/
- **LangChain Documentation**: https://python.langchain.com/
- **Google Gemini API**: https://ai.google.dev/gemini-api/docs

### 緊急連絡先

- **Streamlit Cloud障害**: https://status.streamlit.io/
- **Google AI Studio**: https://aistudio.google.com/

---

## ✅ 管理者チェックリスト

### 日次

- [ ] アプリの稼働確認
- [ ] API使用量の確認
- [ ] エラーログの確認
- [ ] #ai-search-support の対応

### 週次

- [ ] データ更新
- [ ] バックアップ
- [ ] フィードバックの確認

### 月次

- [ ] パスワード変更
- [ ] セキュリティ監査
- [ ] 月次レポート作成
- [ ] 依存パッケージの確認

### 四半期

- [ ] アクセス権限の見直し
- [ ] データの大掃除
- [ ] ユーザーアンケート実施
- [ ] 改善計画の策定

---

**お疲れ様です！適切な運用で、社員の業務効率化に貢献しましょう！** 🚀

