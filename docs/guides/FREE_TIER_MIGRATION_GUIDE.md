# 完全無料版への移行ガイド

株式会社エムエムインターナショナル 社内情報検索AIアプリ

---

## 📋 概要

このガイドでは、OpenAI API（有料）から Google Gemini API（無料）への移行手順を説明します。

### 現在の構成（移行前）
- **ベクターストア:** OpenAI Embeddings（有料）
- **LLM（チャット）:** Google Gemini API（無料）
- **コスト:** 約360円/年（クエリの埋め込み）

### 移行後の構成
- **ベクターストア:** Google Gemini Embeddings（無料）
- **LLM（チャット）:** Google Gemini API（無料）
- **コスト:** 完全無料

---

## ⏰ 実行タイミング

### 重要な注意事項

**Google Gemini APIの無料枠がリセットされた後に実行してください。**

- ✅ **最後にベクターストア作成を試行してから24時間後**
- ✅ **明日（2025年12月14日）の朝以降**

24時間経過していない場合、クォータエラーが発生します。

---

## 🚀 移行手順

### ステップ1: .envファイルを更新

**現在の内容:**
```
OPENAI_API_KEY=sk-proj-...
```

**↓ 以下に変更:**
```
GOOGLE_API_KEY=AIzaSyBlp0GgqOrY5VLVP703PKk-J1UKuDHuhKQ
```

---

### ステップ2: ベクターストアを再作成

**`switch_to_free.bat` をダブルクリック**して実行してください。

**所要時間:** 約5-10分  
**コスト:** 完全無料

**実行中の表示:**
```
============================================================
完全無料版への切り替え
Google Gemini APIでベクターストアを再作成
============================================================

[1/3] 仮想環境をアクティベート中...
完了: 仮想環境をアクティベートしました

[2/3] .envファイルを確認中...
完了: .envファイルが見つかりました

[3/3] ベクターストアを作成中 (Google Gemini API使用)...
これには5-10分かかる場合があります。お待ちください...
💰 コスト: 完全無料

============================================================
ベクターストア作成スクリプト
============================================================

🔄 データを読み込んでいます...
✓ 67個のドキュメントを読み込みました

🔄 テキストを正規化しています...
✓ テキストの正規化が完了しました

🔄 埋め込みモデルを初期化しています...
✓ APIキーを取得しました（先頭10文字: AIzaSyCVOr...）
✓ 埋め込みモデルの初期化が完了しました

🔄 ドキュメントを分割しています...
✓ 216個のチャンクに分割しました

🔄 ベクターストアを作成しています（これには数分かかる場合があります）...
⚠️ この処理中にGoogle Gemini APIのクォータを消費します
✓ ベクターストアの作成が完了しました
✓ ベクターストアを保存しました: ./vectorstore/

============================================================
✅ 完了！完全無料版への切り替えが完了しました！
============================================================
```

---

### ステップ3: GitHubにプッシュ

ベクターストア作成が成功したら、以下のコマンドでGitHubにプッシュします：

```bash
git add vectorstore/
git commit -m "Switch to free tier (Google Gemini Embeddings)"
git push origin main
```

---

### ステップ4: Streamlit CloudのSecretsを確認

Streamlit CloudのSecretsが正しく設定されているか確認してください。

**場所:** Manage app → Settings → Secrets

**内容:**
```toml
GOOGLE_API_KEY = "AIzaSyBlp0GgqOrY5VLVP703PKk-J1UKuDHuhKQ"

[auth]
password = "mmi8686"
session_timeout_minutes = 60
max_login_attempts = 5
```

**重要:** `OPENAI_API_KEY` は削除してください。

---

### ステップ5: アプリを再起動

1. https://share.streamlit.io/ にアクセス
2. `mmi-ai-manager` を選択
3. 左メニューの **「Reboot app」** をクリック
4. 確認ダイアログで **「Reboot app」** をクリック

---

### ステップ6: 動作確認

アプリが起動したら、以下を確認してください：

#### 初期化メッセージ
```
🔄 事前作成されたベクターストアを読み込んでいます...
✓ ベクターストアの読み込みが完了しました
✅ 初期化が正常に完了しました！
```

#### ログイン
- パスワード: `mmi8686`

#### テスト質問
```
質問: 会社の事業内容を教えてください
```

**期待される回答:**
- AI清掃ロボットJINNY
- プロパティマネジメント
- 不動産事業

---

## ❌ トラブルシューティング

### エラー1: `429 You exceeded your current quota`

**原因:** 24時間経過していない

**対処:**
- **24時間待ってから再実行**
- または、別のGoogleアカウントで新しいAPIキーを作成

---

### エラー2: 初期化エラー

**原因:** Streamlit CloudのSecretsが正しく設定されていない

**対処:**
1. Manage app → Settings → Secrets
2. `GOOGLE_API_KEY` が正しく設定されているか確認
3. 保存して再起動

---

## 💰 コスト比較

### 移行前（OpenAI Embeddings）
- **ベクターストア作成:** 約1-2円（一度だけ）
- **クエリの埋め込み:** 約0.01円/質問 = 30円/月 = 360円/年
- **LLM（チャット）:** 無料（Google Gemini API）
- **総コスト:** 約360円/年

### 移行後（Google Gemini Embeddings）
- **ベクターストア作成:** 無料
- **クエリの埋め込み:** 無料
- **LLM（チャット）:** 無料
- **総コスト:** 完全無料

---

## 📊 今後の運用

### 日常運用（社員）
- **完全無料**
- 毎日1500質問まで無料
- 何も気にせず使える

### データ更新（管理者、月1回程度）
1. ローカルで `data/` フォルダを更新
2. `switch_to_free.bat` を実行（無料）
3. GitHubにプッシュ
4. 完了

### 年間コスト
- **完全無料**

---

## ⚠️ 注意事項

### Google Gemini APIの無料枠について

#### 使えるもの
- ✅ **LLM（チャット）:** gemini-1.5-flash
  - 毎日1500リクエスト
  - 十分に使える
- ✅ **埋め込みAPI:** 少ない（データ更新時のみ使用）
  - 216チャンクの埋め込み（月1回程度）なら問題なし

#### クォータの制限
- 一度に大量の埋め込みを行うと、クォータを超過する可能性がある
- 24時間でリセットされる

---

## 🔄 ロールバック（OpenAI APIに戻す）

もし問題が発生した場合、OpenAI APIに戻すことができます。

### 手順

1. `.env` を更新:
   ```
   OPENAI_API_KEY=sk-proj-...
   ```

2. `create_vectorstore_openai.bat` を実行

3. GitHubにプッシュ:
   ```bash
   git add vectorstore/
   git commit -m "Rollback to OpenAI Embeddings"
   git push origin main
   ```

4. Streamlit CloudのSecretsを更新:
   ```toml
   OPENAI_API_KEY = "sk-proj-..."
   GOOGLE_API_KEY = "AIzaSy..."
   
   [auth]
   password = "mmi8686"
   session_timeout_minutes = 60
   max_login_attempts = 5
   ```

5. アプリを再起動

---

## 📅 実行スケジュール

### 今回（2025年12月13日）
- ✅ OpenAI APIでベクターストアを作成
- ✅ GitHubにプッシュ
- ✅ 動作確認

### 明日（2025年12月14日）
- 🔄 Google Gemini APIでベクターストアを再作成
- 🔄 GitHubにプッシュ
- 🔄 完全無料化達成！

---

**作成日:** 2025年12月13日  
**対象:** 株式会社エムエムインターナショナル  
**アプリ名:** mmi-ai-manager  
**バージョン:** 1.0



